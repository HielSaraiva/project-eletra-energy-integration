name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-back:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-back-${{ hashFiles('backend/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-back-

      - id: build-back
        name: Build backend
        run: |
          if [ -f backend/pom.xml ]; then
            mvn -f backend/pom.xml -B -ntp clean package
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
            echo "No backend/pom.xml found, skipping backend build"
          fi

      - name: Upload backend artifact
        if: ${{ steps.build-back.outputs.built == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifact
          path: backend/target/*.jar

  build-front-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # O build nativo do JavaFX 8 costuma precisar de JDK 8 COM JavaFX (ant-javafx.jar).
      - name: Set up Java 8 (with JavaFX)
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: '8'
          java-package: jdk+fx

      - name: Verify JavaFX Ant jar exists
        run: |
          $candidate1 = Join-Path $env:JAVA_HOME 'lib\ant-javafx.jar'
          $candidate2 = Join-Path $env:JAVA_HOME 'jre\..\lib\ant-javafx.jar'
          if (!(Test-Path $candidate1) -and !(Test-Path $candidate2)) {
            Write-Host "JAVA_HOME=$env:JAVA_HOME"
            throw "ant-javafx.jar not found (required by javafx-maven-plugin configuration)."
          }
        shell: powershell

      - name: Install Inno Setup
        run: choco upgrade innosetup -y --no-progress
        shell: powershell

      - name: Verify Inno Setup available
        run: |
          $cmd = Get-Command iscc.exe -ErrorAction SilentlyContinue
          if (-not $cmd) { throw "Inno Setup (iscc.exe) not found in PATH." }
          # Nota: o ISCC pode retornar exit code 1 ao mostrar ajuda; isso não é falha real.
          iscc.exe /? | Out-String | Write-Host
          exit 0
        shell: powershell

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-front-${{ hashFiles('frontend/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-front-

      - id: build-front
        name: Build frontend (JavaFX native)
        run: |
          if exist frontend\pom.xml (
            mvn -f frontend\pom.xml -B -ntp clean package
            echo built=true>>%GITHUB_OUTPUT%
          ) else (
            echo built=false>>%GITHUB_OUTPUT%
            echo No frontend\pom.xml found, skipping frontend build
          )
        shell: cmd

      - name: Upload frontend artifacts
        if: ${{ steps.build-front.outputs.built == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts-windows
          path: |
            frontend/target/*.jar
            frontend/target/jfx/app/**/*
            frontend/target/jfx/native/**/*
